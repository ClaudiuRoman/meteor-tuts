<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <!-- Basic -->
    <title>Named Query | Grapher Docs</title>
    <meta name="description" content="Documentation of how to use Meteor's accounts functionality.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="../images/favicon.png"
          sizes="16x16 32x32 64x64">

    <!-- Social -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://grapher.cultofcoders.com">
    <meta property="og:title" content="Named Query | Grapher Docs">
    <meta property="og:description" content="Documentation of how to use Meteor's accounts functionality.">
    <meta property="og:image" content="">
    <meta name="twitter:card" content="summary_image_large">
    <meta name="twitter:site" content="@culotfcoders">
    <meta name="twitter:title" content="Named Query | Grapher Docs">
    <meta name="twitter:description" content="Documentation of how to use Meteor's accounts functionality.">
    <meta name="twitter:image" content="">

    <!-- Misc -->
    <meta name="google-site-verification" content=""/>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,300italic,400italic'
          rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/style/style.css">
</head>
<body class="">


<div class="nav dark">
  <div class="nav-group">
    <div class="nav-item">
      <span class="js-sidebar-toggle show-mobile">
        <span class="icon-menu"></span>
      </span>
      <a class="logo show-desktop" href="http://www.cultofcoders.com" title="Grapher"  >
        <img src="../images/logo.png" alt="Grapher Docs"/>
        <span></span>
      </a>
    </div>
  </div>

  <div class="center-wrapper show-mobile">
    <img src="../images/logo.png" alt="Grapher Docs"/>
    <div></div>
  </div>

  <div class="nav-group right">
    
      <div class="nav-item show-mobile">
        <span class="js-search-toggle">
          <span class="icon-search"></span>
        </span>
      </div>
    
    
      <div class="nav-item show-desktop ">
        <a class="link" href="https://github.com/cult-of-coders/grapher" target=_new >
          <span>GitHub</span>
        </a>
      </div>
    
      <div class="nav-item show-desktop ">
        <a class="link" href="http://grapher-live.cultofcoders.com/grapher" target=_new >
          <span>Test Live</span>
        </a>
      </div>
    
  </div>

  
    <div class="nav-search">
      <div class="input-symbol">
        <input type="text" placeholder="Search " id="mobile-search-input"/>
        <span class="icon-search"></span>
      </div>

      <div class="nav-group right">
        <div class="nav-item">
          <span class="js-search-toggle">
            <span class="icon-close"></span>
          </span>
        </div>
      </div>

      <div class="wrapper-mobile-search-results"></div>
    </div>
  

</div>

<div class="sidebar">
  <div class="panel">
    <div class="panel-item">
      <a class="" href="http://www.cultofcoders.com" title="Grapher"  >
        <span>Grapher</span>
      </a>
    </div>
    
      <div class="panel-item "">
        <a class="" href="https://github.com/cult-of-coders/grapher" target=_new >
          <span>GitHub</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://grapher-live.cultofcoders.com/grapher" target=_new >
          <span>Test Live</span>
        </a>
      </div>
    
  </div>

  <div class="sidebar-content">
    <div class="topcap">
      <span class="title-sidebar">Grapher Docs</span>
      
    </div>

    
    <div class="wrapper-search">
      <div class="input-symbol small round">
        <input type="text" placeholder="Search " id="desktop-search-input" />
        <span class="icon-search"></span>
      </div>
      <div class="wrapper-desktop-search-results"></div>
    </div>

    

    <ul class="toc">
      
        <li>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="../index.html" class="sidebar-link ">
                  <span>Introducing to Grapher</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Guide</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="links.html" class="sidebar-link ">
                  <span>Collection Links</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="query.html" class="sidebar-link ">
                  <span>Query</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="exposure.html" class="sidebar-link ">
                  <span>Exposure</span>
                </a>
              </li>
            
              
              <li class="item-toc  current">
                <a href="" class="sidebar-link  current">
                  <span>Named Query</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Packages</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="../packages/live.html" class="sidebar-link ">
                  <span>Grapher Live</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="../packages/boilerplate.html" class="sidebar-link ">
                  <span>Grapher Boilerplate</span>
                </a>
              </li>
            
          </ul>
        </li>
      
    </ul>
  </div>
</div>

<div class="content">
  <div class="content-wrapper">
    <div class="header-content">
      <h1 class="title-page">Named Query</h1>
      
        <div class="subtitle-page">Documentation of how to use Meteor's accounts functionality.</div>
      

      <div class="page-actions">
        <div class="actions-group">
          <a class="btn primary small round lowercase" href="https://github.com/cult-of-coders/grapher-docs/tree/master/source/guide/namedQuery.md" target="_blank"><span class="icon-github"></span> <span>Edit on GitHub</span></a>
          
        </div>
      </div>
    </div>

    <div class="document-formatting">
      <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Named Queries are queries which have their form locked on the server. The reason for their existence
is security. Imagine this scenario:</p>
<ul>
<li>You have an Admin that can see all Users</li>
<li>You expose Users collection and check if he is Admin, you allow him</li>
<li>You have a collection Order which is linked to an EndUser and a TeamMember (both in Users collection)</li>
<li>As an EndUser when you see your order you want to see details about the assigned Team Member.</li>
<li>As an EndUser you cannot directly interogate “users” end-point, because you secured it for Admin Only</li>
<li>As an EndUser you cannot interogate “orders” and retrieve “teamMember” because exposures are linked</li>
</ul>
<p>We have two options:</p>
<ul>
<li>Bad Way: Manipulate exposure in such a manner to see if the user is EndUser and has an Order and the ids he wants to see
are linked to an Order he has. But if you do that, then you may also need to restrict the fields he has access to and so on.</li>
<li>Good Way: Use named queries</li>
</ul>
<h2 id="Our-First-Named-Query"><a href="#Our-First-Named-Query" class="headerlink" title="Our First Named Query"></a>Our First Named Query</h2><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">// /imports/api/queries/orderView.js</div><div class="line"><span class="keyword">import</span> &#123; createNamedQuery &#125; from <span class="string">'meteor/cultofcoders:grapher'</span>;</div><div class="line"></div><div class="line">const query = createdNamedQuery(<span class="string">'ordersLirist'</span>, &#123;</div><div class="line">    orders: &#123;</div><div class="line">        $filter(&#123; filters, params &#125;) &#123;</div><div class="line">            filters.enduserId = params._id</div><div class="line">        &#125;</div><div class="line">        details: <span class="number">1</span>,</div><div class="line">        items: <span class="number">1</span>,</div><div class="line">        teamMember: &#123;</div><div class="line">            profile: <span class="number">1</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">export <span class="keyword">default</span> query;</div></pre></td></tr></table></figure>
<h2 id="Fetching-on-Server"><a href="#Fetching-on-Server" class="headerlink" title="Fetching on Server"></a>Fetching on Server</h2><p>We have two ways of handling this on the server-side.</p>
<h3 id="Importing-the-query"><a href="#Importing-the-query" class="headerlink" title="Importing the query"></a>Importing the query</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> query <span class="keyword">from</span> <span class="string">'/imports/api/queries/ordersList'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> data = query.clone(&#123;<span class="attr">_id</span>: <span class="string">'XXX'</span>&#125;).fetch();</div></pre></td></tr></table></figure>
<blockquote class="pullquote warning"><p>We use .clone() method to avoid making changes on the actual query (like setParams). 
You could do is export a factory that creates your query on the fly, however, for simplicity,
we created a .clone() method, that clones the query and it is completely isolated.</p>
</blockquote>
<h3 id="Using-createQuery"><a href="#Using-createQuery" class="headerlink" title="Using: createQuery"></a>Using: createQuery</h3><p>This version has been designed to make it work with <a href="https://github.com/cult-of-coders/grapher-live" target="_blank" rel="external">Grapher-Live</a>,
so you can test your queries on the fly.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> query <span class="keyword">from</span> <span class="string">'/imports/api/queries/ordersList'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> data = createQuery(&#123;</div><div class="line">    <span class="attr">ordersList</span>: &#123;</div><div class="line">        <span class="attr">_id</span>: <span class="string">'XXX'</span> <span class="comment">// Note these are the actual parameters.</span></div><div class="line">    &#125;</div><div class="line">&#125;).fetch()</div></pre></td></tr></table></figure>
<h2 id="Fetching-on-Client"><a href="#Fetching-on-Client" class="headerlink" title="Fetching on Client"></a>Fetching on Client</h2><p>In order to fetch it client-side, you need to expose this query server-side.</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// server-side code</span></div><div class="line">import ordersListQuery <span class="keyword">from</span> <span class="string">'/imports/api/queries/ordersList'</span>;</div><div class="line"></div><div class="line">ordersListQuery.expose(<span class="comment">&#123;</span></div><div class="line">    firewall(userId, params) &#123; // optional, but important!</div><div class="line">        // throw exception or modify params to make it secure, in the example above we'll do</div><div class="line">        params._id = userId</div><div class="line">    &#125;),</div><div class="line">    <span class="function"><span class="keyword">method</span>:</span> <span class="keyword">true</span>, <span class="comment">// defaults to true, allows you to fetch it statically</span></div><div class="line">    publication: <span class="keyword">true</span>, <span class="comment">// defaults to true, allows you to fetch it reactively,</span></div><div class="line">    embody: <span class="comment">&#123; //optional</span></div><div class="line">        // deep merges with the query body after the first node</div><div class="line">        // this allows you to have full control over the query without exposing important business logic to the client</div><div class="line">        teamMember: &#123;</div><div class="line">            $filters: &#123;isActive: true&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// if you're just playing with it and want to see it works:</span></div><div class="line">ordersListQuery.expose();</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// client-side code</span></div><div class="line"><span class="keyword">import</span> ordersListQuery <span class="keyword">from</span> <span class="string">'/imports/api/queries/ordersList'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> query = ordersListQuery.clone(params);</div><div class="line"></div><div class="line"><span class="comment">// statically (Works exactly like a Normal Query)</span></div><div class="line">query.fetch(<span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;&#125;); <span class="comment">// Works exactly like a Normal Query</span></div><div class="line"></div><div class="line"><span class="comment">// reactively (Works exactly like a Normal Query)</span></div><div class="line"><span class="keyword">const</span> handle = query.subscribe(); </div><div class="line">query.fetch();</div></pre></td></tr></table></figure>
<p>If you have imported the named query anywhere, then the name will be present in the store, meaning you can do:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// client-side code</span></div><div class="line"><span class="selector-tag">createQuery</span>(&#123;</div><div class="line">    <span class="attribute">ordersListQuery</span>: &#123;params&#125;</div><div class="line">&#125;)<span class="selector-class">.fetch</span>((err, data) =&gt; &#123;</div><div class="line">    <span class="comment">// do something with the data</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>It removes the boilerplate of you having to clone it. the reason for this was to allow it to work with <a href="https://github.com/cult-of-coders/grapher-live" target="_blank" rel="external">Grapher-Live</a></p>
<h2 id="Why-Collection-Exposure"><a href="#Why-Collection-Exposure" class="headerlink" title="Why Collection Exposure ?"></a>Why Collection Exposure ?</h2><p>You might be asking at this stage, why do we still allow “flexible” queries via Collection Exposure. And it’s a damn good question.
If your database is simple and can be easily secured then it is much simpler to avoid namedQueries and it’s easier to expose an API,
through which a client can request what he wants only, without having a lot of named queries.</p>

    </div>
  </div>

  <div class="pagination">
    <div class="content-wrapper">
      
      
        <a class="link primary prev"
          href="exposure.html">
          <span class="icon-arrow-left-alt"></span>
          <span class="subtitle-pagination">Previous</span>
          Exposure
        </a>
      
      
        <a class="link primary next"
          href="../packages/live.html">
          <span class="subtitle-pagination">Next</span>
          Grapher Live
          <span class="icon-arrow-right-alt"></span>
        </a>
      
    </div>
  </div>

  <div class="github">
    <a class="link tertiary " href="https://github.com/cult-of-coders/grapher-docs/tree/master/source/guide/namedQuery.md" target="_blank">
      <span class="icon-github"></span>Edit on GitHub</a>
  </div>

  
</div>

<script src="/script/smooth-scroll.min.js"></script>
<script src="/script/main.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

<script>
    
    // Google analytics
    ;
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-40568040-9', 'auto');
    ga('send', 'pageview');
    

    

    // search box
    
    ['desktop', 'mobile'].forEach(function (type) {
        var search = docsearch({
            apiKey: 'c6162b5842b0dc5f7af8c186fff8f5bb',
            indexName: 'grapher',
            inputSelector: '#' + type + '-search-input',
            autocompleteOptions: {
                dropdownMenuContainer: '.wrapper-' + type + '-search-results',
                debug: true
            },
            algoliaOptions: {
                hitsPerPage: 20
            }
        }).autocomplete;
        var sidebar = document.querySelector('.sidebar-content');
        search.on('autocomplete:opened', function () {
            sidebar.classList.add('searching');
        });
        search.on('autocomplete:closed', function () {
            sidebar.classList.remove('searching');
        });
        search.on('autocomplete:updated', function () {
            if (search.val() === '') {
                search.autocomplete.close();
            }
        });
    });
    

    
</script>
</body>
</html>
